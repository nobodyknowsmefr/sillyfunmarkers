<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bird Garden - Growing Flowers</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Verdana, Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        #gameContainer {
            position: relative;
            max-width: 100vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #canvasWrapper {
            position: relative;
        }
        
        #titleImage {
            width: 100%;
            max-width: 600px;
            height: auto;
            margin-bottom: 10px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        canvas {
            display: block;
            border: 3px solid #ff6600;
            cursor: pointer;
            touch-action: none;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            pointer-events: none;
            display: none;
            text-align: right;
        }
        
        #backBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff6600;
            color: white;
            padding: 10px 20px;
            border: 2px solid #ff3300;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            font-size: 12px;
            text-transform: uppercase;
            z-index: 100;
        }
        
        #backBtn:hover {
            background-color: #ff3300;
        }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff6600;
            font-size: 12px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            pointer-events: none;
        }
        
        #shopAd {
            position: fixed;
            right: 1500px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            z-index: 50;
            border: 3px solid #ff0000;
            background-color: #000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        #shopAd img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #birdAd {
            position: fixed;
            right: 1500px;
            top: 75%;
            transform: translateY(-50%);
            width: 400px;
            z-index: 50;
            border: 3px solid #ff0000;
            background-color: #000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        #birdAd img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        @media (max-width: 768px) {
            #backBtn {
                padding: 8px 15px;
                font-size: 10px;
            }
            
            #ui {
                font-size: 12px;
            }
            
            #instructions {
                display: none; /* Hide instructions on mobile */
            }
            
            #titleImage {
                max-width: 90%;
                margin-bottom: 5px;
            }
            
            #shopAd {
                position: fixed;
                right: auto;
                top: auto;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 205px;
                max-width: 220px;
            }
            
            #birdAd {
                position: fixed;
                top: 10px;
                left: 10px;
                right: auto;
                bottom: auto;
                transform: none;
                width: 200px;
                max-width: 250px;
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <a href="games.html" id="backBtn">‚Üê Back to Games</a>
    
    <div id="shopAd">
    <a href="dontayvious.html">
        <img src="shop.gif" alt="SHOP NOW!">
    </a>
</div>
    
    <div id="birdAd">
        <img src="birdad.png" alt="Bird Ad">
    </div>
    
    <div id="gameContainer">
        <img id="titleImage" src="birdtitle.png" alt="Bird Game">
        <div id="canvasWrapper">
            <canvas id="gameCanvas"></canvas>
            <div id="ui">
                <div>Seeds: <span id="seedCount">0</span></div>
                <div>Flowers: <span id="flowerCount">0</span></div>
            </div>
        </div>
    </div>
    
    <div id="instructions">
        Grow flowers to survive! Click/Tap to guide the bird üå±‚è±Ô∏è<br>
        <span style="color: #ff0000;">Watch out for the hands - they eat your seeds!</span>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size
        function resizeCanvas() {
            const maxWidth = window.innerWidth * 0.95;
            const maxHeight = window.innerHeight * 0.85;
            const aspectRatio = 4/3;
            
            if (maxWidth / aspectRatio <= maxHeight) {
                canvas.width = Math.min(800, maxWidth);
                canvas.height = canvas.width / aspectRatio;
            } else {
                canvas.height = Math.min(600, maxHeight);
                canvas.width = canvas.height * aspectRatio;
            }
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

                // Detect if device is mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || (window.innerWidth <= 768);
        }
        
        // Game state
        let seeds = [];
        let flowers = [];
        let seedCount = 0;
        let flowerCount = 0;
        
        // Hands array
        let hands = [];
        let handSpawnTimer = 0;
        let nextHandSpawnTime = 60;
        
        // Bird state
        const bird = {
            x: canvas.width / 2,
            y: canvas.height / 3,
            targetX: canvas.width / 2,
            targetY: canvas.height / 3,
            size: 40,
            speed: 3,
            seedTimer: 0,
            seedInterval: 30,
            animFrame: 0,
            animSpeed: 10,
            facingRight: true,
            lastX: canvas.width / 2,
            lastY: canvas.height / 3
        };
        
        // Images
        const bgImage = new Image();
        bgImage.src = 'bkg.png';
        
        const bgImage2 = new Image();
        bgImage2.src = 'bkg2.png';
        
        const birdImage1 = new Image();
        birdImage1.src = 'bird.png';
        
        const birdImage2 = new Image();
        birdImage2.src = 'bird2.png';
        
        const whistleImage1 = new Image();
        whistleImage1.src = 'whistle.png';
        
        const whistleImage2 = new Image();
        whistleImage2.src = 'whistle2.png';
        
        const handImage = new Image();
        handImage.src = 'hand.png';
        
        // Audio
        const whistleSound = new Audio('whistle.wav');
        whistleSound.volume = 0.8;
        
        const gameSong = new Audio('gamesong.mp3');
        gameSong.volume = 0.6;
        gameSong.preload = 'auto';
        
        let audioUnlocked = false;
        let musicShouldBePlaying = false;
        
        // Manually loop the music
        gameSong.addEventListener('ended', () => {
            if (musicShouldBePlaying) {
                console.log('Music ended, restarting...');
                gameSong.currentTime = 0;
                gameSong.play().catch(e => console.error('Loop restart failed:', e));
            }
        });
        
        gameSong.addEventListener('canplaythrough', () => {
            console.log('‚úì gamesong.mp3 loaded successfully');
        });
        
        gameSong.addEventListener('error', (e) => {
            console.error('‚úó AUDIO FILE ERROR!');
        });
        
        let imagesLoaded = 0;
        const totalImages = 7;
        
        bgImage.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        bgImage2.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        birdImage1.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        birdImage2.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        whistleImage1.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        whistleImage2.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        handImage.onload = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        
        bgImage.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        bgImage2.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        birdImage1.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        birdImage2.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        whistleImage1.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        whistleImage2.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        handImage.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) startGame(); };
        
        // Game states
        let gameState = 'start'; // start, countdown, playing, lost, levelComplete
        let currentLevel = 1;
        let countdownTimer = 3;
        let countdownFrames = 0;
        let gameTimer = 15;
        let gameFrames = 0;
        let targetSeeds = 300;
        let canControl = false;
        let whistleShown = false;
        let audioContext = null;
        let countdownBeep = null;
        let whistleExitTimer = 0;
        let whistleExitDuration = 120;
        let whistleOffsetX = 0;
        let whistleExitSpeed = 8;
        
        // Difficulty scaling variables
        let baseHandSpawnTime = 60; // Starting spawn time (1 second)
        let handExtensionMultiplier = 1.0; // Multiplier for how far hands reach
        let handSpeedMultiplier = 1.0; // Multiplier for how fast hands move
        
        // Initialize audio context on first user interaction
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            if (!audioUnlocked) {
                console.log('Unlocking audio...');
                gameSong.load();
                whistleSound.load();
                audioUnlocked = true;
            }
        }
        
        // Play sine wave beep
        function playBeep(frequency = 800, duration = 0.1) {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Beep failed:', e);
            }
        }
        
        // Calculate difficulty for current level
        function calculateDifficulty() {
            // Flower requirement increases each level
            targetSeeds = 300 + (currentLevel - 1) * 50; // 300, 350, 400, 450...
            
            // Time decreases slightly (minimum 10 seconds)
            gameTimer = Math.max(10, 15 - Math.floor((currentLevel - 1) / 3));
            
            // Hands spawn faster each level (gets VERY fast at higher levels)
            baseHandSpawnTime = Math.max(15, 60 - (currentLevel - 1) * 4); // Gets faster each level, min 15 frames (0.25s)
            nextHandSpawnTime = Math.random() * baseHandSpawnTime * 0.5 + baseHandSpawnTime * 0.5;
            
            // Hands reach MUCH further each level (up to 2.5x screen width!)
            handExtensionMultiplier = Math.min(2.5, 1.0 + (currentLevel - 1) * 0.08);
            
            // Hands move progressively faster (extension and retraction speed increase)
            handSpeedMultiplier = Math.min(3.0, 1.0 + (currentLevel - 1) * 0.1);
        }
        
        // Reset game
        function resetGame() {
            gameState = 'start';
            currentLevel = 1;
            countdownTimer = 3;
            countdownFrames = 0;
            seedCount = 0;
            flowerCount = 0;
            seeds = [];
            flowers = [];
            hands = [];
            handSpawnTimer = 0;
            canControl = false;
            whistleShown = false;
            whistleExitTimer = 0;
            whistleOffsetX = 0;
            bird.x = canvas.width / 2;
            bird.y = canvas.height / 3;
            bird.targetX = canvas.width / 2;
            bird.targetY = canvas.height / 3;
            
            // Reset difficulty
            calculateDifficulty();
            
            // Stop and reset game song
            musicShouldBePlaying = false;
            gameSong.pause();
            gameSong.currentTime = 0;
        }
        
        // Advance to next level
        function nextLevel() {
            currentLevel++;
            gameState = 'countdown';
            countdownTimer = 3;
            countdownFrames = 0;
            gameFrames = 0;
            seedCount = 0;
            flowerCount = 0;
            
            // Calculate new difficulty
            calculateDifficulty();
            
            seeds = [];
            flowers = [];
            hands = [];
            handSpawnTimer = 0;
            canControl = false;
            whistleShown = false;
            whistleExitTimer = 0;
            whistleOffsetX = 0;
            bird.x = canvas.width / 2;
            bird.y = canvas.height / 3;
            bird.targetX = canvas.width / 2;
            bird.targetY = canvas.height / 3;
        }
        
        // Hand class
        class Hand {
            constructor(side) {
                this.side = side;
                this.height = 150;
                
                // Spawn from LOWER positions (bottom 70% of screen - where the action is!)
                const minY = canvas.height * 0.3; // Start from 30% down
                const maxY = canvas.height - this.height - 20;
                this.y = Math.random() * (maxY - minY) + minY;
                
                // Extension affected by difficulty multiplier - can reach WAY past middle!
                const baseExtension = canvas.width * (0.4 + Math.random() * 0.35);
                this.maxExtension = baseExtension * handExtensionMultiplier;
                this.currentExtension = 0;
                this.extending = true;
                
                // Speed increases with difficulty - FAST hands!
                this.extensionSpeed = 12 * handSpeedMultiplier;
                this.retractSpeed = 8 * handSpeedMultiplier;
                this.holdTime = Math.max(10, 20 - currentLevel); // Hold less time at higher levels
                this.holdTimer = 0;
                this.alive = true;
            }
            
            update() {
                if (this.extending) {
                    this.currentExtension += this.extensionSpeed;
                    
                    if (this.currentExtension >= this.maxExtension) {
                        this.currentExtension = this.maxExtension;
                        this.extending = false;
                        this.holdTimer = this.holdTime;
                    }
                } else if (this.holdTimer > 0) {
                    this.holdTimer--;
                } else {
                    this.currentExtension -= this.retractSpeed;
                    
                    if (this.currentExtension <= 0) {
                        this.alive = false;
                    }
                }
            }
            
            draw() {
                ctx.save();
                
                if (this.side === 'left') {
                    const x = 0;
                    const width = this.currentExtension;
                    
                    if (handImage.complete && handImage.naturalWidth > 0) {
                        ctx.drawImage(handImage, x, this.y, width, this.height);
                    } else {
                        ctx.fillStyle = '#FFE4C4';
                        ctx.fillRect(x, this.y, width, this.height);
                    }
                } else {
                    const x = canvas.width - this.currentExtension;
                    const width = this.currentExtension;
                    
                    ctx.translate(canvas.width, this.y);
                    ctx.scale(-1, 1);
                    
                    if (handImage.complete && handImage.naturalWidth > 0) {
                        ctx.drawImage(handImage, 0, 0, width, this.height);
                    } else {
                        ctx.fillStyle = '#FFE4C4';
                        ctx.fillRect(0, 0, width, this.height);
                    }
                }
                
                ctx.restore();
            }
            
            getCollisionBox() {
                if (this.side === 'left') {
                    return {
                        x: 0,
                        y: this.y,
                        width: this.currentExtension,
                        height: this.height
                    };
                } else {
                    return {
                        x: canvas.width - this.currentExtension,
                        y: this.y,
                        width: this.currentExtension,
                        height: this.height
                    };
                }
            }
        }
        
        // Seed class
        class Seed {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = 0;
                this.size = 3;
                this.gravity = 0.3;
                this.planted = false;
                this.color = '#8B4513';
            }
            
            update() {
                if (!this.planted) {
                    this.vy += this.gravity;
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // Check collision with hands
                    for (let hand of hands) {
                        const box = hand.getCollisionBox();
                        if (this.x > box.x && 
                            this.x < box.x + box.width &&
                            this.y > box.y && 
                            this.y < box.y + box.height) {
                            return true; // Seed absorbed
                        }
                    }
                    
                    // Check if hit ground
                    if (this.y >= canvas.height - 5) {
                        this.planted = true;
                        this.y = canvas.height - 5;
                        flowers.push(new Flower(this.x, this.y));
                        flowerCount++;
                        return true;
                    }
                }
                return false;
            }
            
            draw() {
                if (!this.planted) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        // Flower class
        class Flower {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.height = 0;
                this.maxHeight = 30 + Math.random() * 40;
                this.growthRate = 0.2 + Math.random() * 0.3;
                this.stemWidth = 2;
                this.petalSize = 5 + Math.random() * 8;
                this.petalCount = 5 + Math.floor(Math.random() * 3);
                this.hue = Math.random() * 360;
                this.age = 0;
            }
            
            update() {
                if (this.height < this.maxHeight) {
                    this.height += this.growthRate;
                }
                this.age++;
            }
            
            draw() {
                if (this.height > 0) {
                    // Stem
                    ctx.strokeStyle = '#228B22';
                    ctx.lineWidth = this.stemWidth;
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x, this.y - this.height);
                    ctx.stroke();
                    
                    // Flower petals
                    if (this.height > this.maxHeight * 0.6) {
                        const flowerX = this.x;
                        const flowerY = this.y - this.height;
                        
                        for (let i = 0; i < this.petalCount; i++) {
                            const angle = (Math.PI * 2 / this.petalCount) * i;
                            const px = flowerX + Math.cos(angle) * this.petalSize;
                            const py = flowerY + Math.sin(angle) * this.petalSize;
                            
                            ctx.fillStyle = `hsl(${this.hue}, 70%, 60%)`;
                            ctx.beginPath();
                            ctx.arc(px, py, this.petalSize * 0.6, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        
                        // Center
                        ctx.fillStyle = '#FFD700';
                        ctx.beginPath();
                        ctx.arc(flowerX, flowerY, this.petalSize * 0.4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        }
        
        // Update bird position
        function updateBird() {
            bird.lastX = bird.x;
            bird.lastY = bird.y;
            
            const dx = bird.targetX - bird.x;
            const dy = bird.targetY - bird.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 5) {
                bird.x += (dx / distance) * bird.speed;
                bird.y += (dy / distance) * bird.speed;
                
                if (dx > 0.5) {
                    bird.facingRight = true;
                } else if (dx < -0.5) {
                    bird.facingRight = false;
                }
            }
            
            bird.animFrame++;
            
            bird.seedTimer++;
            if (bird.seedTimer >= bird.seedInterval) {
                dropSeed();
                bird.seedTimer = 0;
            }
        }
        
        // Drop a seed from bird
        function dropSeed() {
            seeds.push(new Seed(bird.x, bird.y + bird.size/2));
            seedCount++;
        }
        
        // Input handling
        function handleInput(e) {
            if (gameState === 'start' || gameState === 'lost') {
                return;
            }
            
            if (!canControl) {
                initAudio();
                return;
            }
            
            if (musicShouldBePlaying && gameSong.paused) {
                console.log('Attempting to start paused music...');
                gameSong.play()
                    .then(() => console.log('‚úì Music started on tap!'))
                    .catch(err => console.error('‚úó Still failed:', err));
            }
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            bird.targetX = (clientX - rect.left) * (canvas.width / rect.width);
            bird.targetY = (clientY - rect.top) * (canvas.height / rect.height);
            
            // Prevent bird from going too close to the ground (minimum 200px from bottom - STAY HIGH!)
            // Prevent bird from going too close to the ground
            // Mobile: 80px from bottom (easier), Desktop: 200px from bottom (harder)
            const groundLimit = isMobile() ? canvas.height - 80 : canvas.height - 200;
            if (bird.targetY > groundLimit) {
                bird.targetY = groundLimit;
            }
            
            dropSeed();
        }
        
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput);
        canvas.addEventListener('mousemove', (e) => {
            if (e.buttons === 1) handleInput(e);
        });
        canvas.addEventListener('touchmove', handleInput);
        
        // Handle restart and level progression
        function handleScreenTap(e) {
            if (gameState === 'start') {
                initAudio();
                
                musicShouldBePlaying = true;
                gameSong.volume = 0.6;
                gameSong.currentTime = 0;
                
                console.log('Starting music...');
                
                gameSong.play()
                    .then(() => console.log('‚úÖ Music playing!'))
                    .catch(error => console.error('‚ùå Music failed:', error));
                
                gameState = 'countdown';
            } else if (gameState === 'levelComplete') {
                // Continue to next level
                gameSong.currentTime = 0;
                gameSong.volume = 0.6;
                musicShouldBePlaying = true;
                gameSong.play()
                    .then(() => console.log('‚úì Next level music started'))
                    .catch(e => console.error('‚úó Music failed:', e));
                
                nextLevel();
            } else if (gameState === 'lost') {
                resetGame();
            }
        }
        
        canvas.addEventListener('click', handleScreenTap);
        canvas.addEventListener('touchstart', (e) => {
            if (gameState === 'start' || gameState === 'levelComplete' || gameState === 'lost') {
                e.preventDefault();
                handleScreenTap(e);
            }
        });
        
        // Game loop
        function gameLoop() {
            // Alternate backgrounds based on level (odd = bg1, even = bg2)
            const currentBgImage = currentLevel % 2 === 1 ? bgImage : bgImage2;
            
            if (currentBgImage.complete && currentBgImage.naturalWidth > 0) {
                ctx.drawImage(currentBgImage, 0, 0, canvas.width, canvas.height);
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#98FB98');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Draw ground
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, canvas.height - 10, canvas.width, 10);
            ctx.fillStyle = '#228B22';
            ctx.fillRect(0, canvas.height - 15, canvas.width, 5);
            
            // START STATE
            if (gameState === 'start') {
                ctx.fillStyle = '#FF6600';
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = Math.max(3, canvas.width * 0.008);
                const startFontSize = Math.min(60, canvas.width * 0.1);
                ctx.font = `bold ${startFontSize}px Verdana`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText('TAP TO START', canvas.width / 2, canvas.height / 2);
                ctx.fillText('TAP TO START', canvas.width / 2, canvas.height / 2);
                
                const pulse = Math.sin(Date.now() / 300) * 0.1 + 0.9;
                ctx.globalAlpha = pulse;
                ctx.fillStyle = '#FFD700';
                const instructionFontSize = Math.min(24, canvas.width * 0.04);
                ctx.font = `bold ${instructionFontSize}px Verdana`;
                ctx.fillText('Grow as many flowers as you can!', canvas.width / 2, canvas.height / 2 + 60);
                ctx.fillText('Each level gets HARDER!', canvas.width / 2, canvas.height / 2 + 90);
                ctx.globalAlpha = 1;
            }
            // COUNTDOWN STATE
            else if (gameState === 'countdown') {
                countdownFrames++;
                
                if (countdownFrames >= 60) {
                    countdownFrames = 0;
                    countdownTimer--;
                    playBeep(800, 0.15);
                    
                    if (countdownTimer <= 0) {
                        gameState = 'playing';
                        canControl = true;
                        whistleShown = true;
                        whistleSound.play().catch(e => console.log('Whistle sound failed:', e));
                    }
                }
                
                const whistleImage = whistleShown ? whistleImage2 : whistleImage1;
                const whistleWidth = 150;
                const whistleHeight = 450;
                const whistleX = canvas.width - whistleWidth - -70;
                const whistleY = canvas.height / 2 - whistleHeight / 2;
                
                if (whistleImage.complete && whistleImage.naturalWidth > 0) {
                    ctx.drawImage(whistleImage, whistleX, whistleY, whistleWidth, whistleHeight);
                } else {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(whistleX, whistleY, whistleWidth, whistleHeight);
                }
                
                ctx.fillStyle = '#FF0000';
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = Math.max(3, canvas.width * 0.008);
                const countdownFontSize = Math.min(120, canvas.width * 0.2);
                ctx.font = `bold ${countdownFontSize}px Verdana`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const text = countdownTimer > 0 ? countdownTimer.toString() : 'GO!';
                ctx.strokeText(text, canvas.width / 2, canvas.height / 2);
                ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            }
            // PLAYING STATE
            else if (gameState === 'playing') {
                gameFrames++;
                
                if (whistleExitTimer < whistleExitDuration) {
                    whistleExitTimer++;
                    
                    if (whistleExitTimer > 30) {
                        whistleOffsetX += whistleExitSpeed;
                    }
                }
                
                if (gameFrames >= 60) {
                    gameFrames = 0;
                    gameTimer--;
                    
                    if (gameTimer <= 0) {
                        // Time's up - check if won
                        if (flowerCount >= targetSeeds) {
                            gameState = 'levelComplete';
                        } else {
                            gameState = 'lost';
                        }
                        musicShouldBePlaying = false;
                        gameSong.pause();
                        gameSong.currentTime = 0;
                    }
                }
                
                // Check win condition
                if (flowerCount >= targetSeeds && gameState === 'playing') {
                    gameState = 'levelComplete';
                    musicShouldBePlaying = false;
                    gameSong.pause();
                    gameSong.currentTime = 0;
                }
                
                // Hand spawning
                handSpawnTimer++;
                if (handSpawnTimer >= nextHandSpawnTime) {
                    const side = Math.random() < 0.5 ? 'left' : 'right';
                    hands.push(new Hand(side));
                    
                    nextHandSpawnTime = Math.random() * baseHandSpawnTime * 0.5 + baseHandSpawnTime * 0.5;
                    handSpawnTimer = 0;
                }
                
                // Update hands
                for (let i = hands.length - 1; i >= 0; i--) {
                    hands[i].update();
                    if (!hands[i].alive) {
                        hands.splice(i, 1);
                    }
                }
                
                // Update flowers
                for (let flower of flowers) {
                    flower.update();
                }
                
                // Update seeds
                for (let i = seeds.length - 1; i >= 0; i--) {
                    if (seeds[i].update()) {
                        seeds.splice(i, 1);
                    }
                }
                
                updateBird();
                
                // Draw flowers
                for (let flower of flowers) {
                    flower.draw();
                }
                
                // Draw seeds
                for (let seed of seeds) {
                    seed.draw();
                }
                
                // Draw hands
                for (let hand of hands) {
                    hand.draw();
                }
                
                // Draw whistle exit
                if (whistleExitTimer < whistleExitDuration) {
                    const whistleImage = whistleImage2;
                    const whistleWidth = 150;
                    const whistleHeight = 450;
                    const whistleX = canvas.width - whistleWidth - -70 + whistleOffsetX;
                    const whistleY = canvas.height / 2 - whistleHeight / 2;
                    
                    if (whistleX < canvas.width) {
                        if (whistleImage.complete && whistleImage.naturalWidth > 0) {
                            ctx.drawImage(whistleImage, whistleX, whistleY, whistleWidth, whistleHeight);
                        } else {
                            ctx.fillStyle = '#FFD700';
                            ctx.fillRect(whistleX, whistleY, whistleWidth, whistleHeight);
                        }
                    }
                }
                
                // Draw bird
                const birdImg = Math.floor(bird.animFrame / bird.animSpeed) % 2 === 0 ? birdImage1 : birdImage2;
                ctx.save();
                ctx.translate(bird.x, bird.y);
                if (!bird.facingRight) {
                    ctx.scale(-1, 1);
                }
                
                if (birdImg.complete && birdImg.naturalWidth > 0) {
                    ctx.drawImage(birdImg, -bird.size/2, -bird.size/2, bird.size, bird.size);
                } else {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(0, 0, bird.size/2, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
                
                // Draw timer
                ctx.fillStyle = gameTimer <= 5 ? '#FF0000' : '#FFD700';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                const timerFontSize = Math.min(32, canvas.width * 0.053);
                ctx.font = `bold ${timerFontSize}px Verdana`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const timerText = `Time: ${gameTimer}s`;
                ctx.strokeText(timerText, canvas.width / 2, 10);
                ctx.fillText(timerText, canvas.width / 2, 10);
                
                // Draw level indicator
                ctx.fillStyle = '#FF6600';
                const levelFontSize = Math.min(20, canvas.width * 0.033);
                ctx.font = `bold ${levelFontSize}px Verdana`;
                ctx.textAlign = 'left';
                const levelText = `LEVEL ${currentLevel}`;
                ctx.strokeText(levelText, 10, 10);
                ctx.fillText(levelText, 10, 10);
                
                // Draw seed progress
                ctx.fillStyle = '#00FF00';
                const progressFontSize = Math.min(24, canvas.width * 0.04);
                ctx.font = `bold ${progressFontSize}px Verdana`;
                ctx.textAlign = 'center';
                const progressText = `Flowers: ${flowerCount}/${targetSeeds}`;
                ctx.strokeText(progressText, canvas.width / 2, 10 + timerFontSize + 5);
                ctx.fillText(progressText, canvas.width / 2, 10 + timerFontSize + 5);
            }
            // LEVEL COMPLETE STATE
            else if (gameState === 'levelComplete') {
                for (let flower of flowers) {
                    flower.update();
                    flower.draw();
                }
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FFD700';
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = Math.max(3, canvas.width * 0.008);
                const completeFontSize = Math.min(50, canvas.width * 0.08);
                ctx.font = `bold ${completeFontSize}px Verdana`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(`LEVEL ${currentLevel} COMPLETE!`, canvas.width / 2, canvas.height / 2 - 50);
                ctx.fillText(`LEVEL ${currentLevel} COMPLETE!`, canvas.width / 2, canvas.height / 2 - 50);
                
                ctx.fillStyle = '#FFFFFF';
                const detailFontSize = Math.min(20, canvas.width * 0.033);
                ctx.font = `bold ${detailFontSize}px Verdana`;
                ctx.fillText(`${flowerCount} flowers grown!`, canvas.width / 2, canvas.height / 2 + 20);
                
                // Show next level difficulty
                const nextTargetSeeds = 300 + currentLevel * 50;
                ctx.fillText(`Next: ${nextTargetSeeds} flowers needed`, canvas.width / 2, canvas.height / 2 + 50);
                
                const pulse = Math.sin(Date.now() / 300) * 0.1 + 0.9;
                ctx.globalAlpha = pulse;
                ctx.fillStyle = '#00FF00';
                ctx.fillText(`Click for LEVEL ${currentLevel + 1}!`, canvas.width / 2, canvas.height / 2 + 90);
                ctx.globalAlpha = 1;
            }
            // LOST STATE
            else if (gameState === 'lost') {
                for (let flower of flowers) {
                    flower.update();
                    flower.draw();
                }
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FF0000';
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = Math.max(3, canvas.width * 0.008);
                const lostFontSize = Math.min(80, canvas.width * 0.13);
                ctx.font = `bold ${lostFontSize}px Verdana`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText('TIME\'S UP!', canvas.width / 2, canvas.height / 2 - 70);
                ctx.fillText('TIME\'S UP!', canvas.width / 2, canvas.height / 2 - 70);
                
                ctx.fillStyle = '#FFFFFF';
                const lostDetailFontSize = Math.min(24, canvas.width * 0.04);
                ctx.font = `bold ${lostDetailFontSize}px Verdana`;
                ctx.fillText(`Failed on Level ${currentLevel}!`, canvas.width / 2, canvas.height / 2 - 10);
                ctx.fillText(`Only ${flowerCount}/${targetSeeds} flowers grown`, canvas.width / 2, canvas.height / 2 + 20);
                
                // Show highest level reached
                ctx.fillStyle = '#FFD700';
                ctx.fillText(`You reached Level ${currentLevel}!`, canvas.width / 2, canvas.height / 2 + 60);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText('Click to try again', canvas.width / 2, canvas.height / 2 + 100);
            }
            
            // Update UI
            const uiElement = document.getElementById('ui');
            if (gameState === 'playing') {
                uiElement.style.display = 'block';
                document.getElementById('seedCount').textContent = seedCount;
                document.getElementById('flowerCount').textContent = flowerCount;
            } else {
                uiElement.style.display = 'none';
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            console.log('Game started!');
            calculateDifficulty(); // Initialize difficulty
            gameLoop();
        }
        
        if (imagesLoaded === totalImages) {
            startGame();
        }
    </script>
</body>

</html>

